name: Pipeline CI/CD

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

# VariÃ¡veis de ambiente disponÃ­veis para todos os jobs no workflow
env:
  ECR_REPOSITORY: pipeline-devops
  AWS_REGION: us-east-1

jobs:
  # Job 1: Executa testes e build local
  test-and-build:
    name: Testes e Build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v4
      
      - name: Instala o Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Instala as dependÃªncias
        run: npm ci

      - name: Executa testes automatizados
        run: npm run test:ci

      - name: AnÃ¡lise de seguranÃ§a de dependÃªncias
        run: npm audit --audit-level moderate

      - name: Faz o build da aplicaÃ§Ã£o
        run: npm run build

      - name: Cache dos artefatos de build
        uses: actions/upload-artifact@v4
        with:
          name: build-files
          path: build/
          retention-days: 1

  # Job 2: Deploy (sÃ³ executa se os testes passaram)
  deploy:
    name: Deploy para AWS ECR
    runs-on: ubuntu-latest
    needs: test-and-build  # SÃ³ executa se o job anterior passou
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'  # SÃ³ no push para main
    
    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: Baixa artefatos de build
        uses: actions/download-artifact@v4
        with:
          name: build-files
          path: build/

      - name: Configurar credenciais da AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }}
          mask-aws-account-id: 'no'

      - name: Login no Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Definir tag da imagem (SHA do commit)
        id: image_tag
        run: echo "tag=$(echo ${GITHUB_SHA} | cut -c1-7)" >> $GITHUB_OUTPUT

      - name: Build e Push da imagem para o Amazon ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ steps.image_tag.outputs.tag }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG -f Dockerfile .
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          echo "âœ… Imagem enviada com sucesso para $ECR_REGISTRY/$ECR_REPOSITORY com as tags '$IMAGE_TAG' e 'latest'"

      - name: Scan de seguranÃ§a da imagem Docker
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ steps.image_tag.outputs.tag }}
        run: |
          # Aguarda um pouco para o ECR processar a imagem
          sleep 30
          # Executa scan de vulnerabilidades
          aws ecr start-image-scan --repository-name $ECR_REPOSITORY --image-id imageTag=$IMAGE_TAG || true
          echo "ðŸ” Scan de seguranÃ§a iniciado para a imagem"

      - name: Obter URL da aplicaÃ§Ã£o
        id: get-app-url
        run: |
          APP_URL=$(aws elbv2 describe-load-balancers \
            --names pipeline-devops-github-alb \
            --query 'LoadBalancers[0].DNSName' \
            --output text 2>/dev/null || echo "URL nÃ£o disponÃ­vel")
          
          if [ "$APP_URL" != "URL nÃ£o disponÃ­vel" ] && [ "$APP_URL" != "None" ]; then
            APP_URL="http://$APP_URL"
          fi
          
          echo "app-url=$APP_URL" >> $GITHUB_OUTPUT

      - name: Criar Job Summary com URL da aplicaÃ§Ã£o
        env:
          APP_URL: ${{ steps.get-app-url.outputs.app-url }}
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ðŸ”— [Acessar AplicaÃ§Ã£o](${{ env.APP_URL }})
          EOF

      - name: Mensagem de sucesso do deploy
        env:
          APP_URL: ${{ steps.get-app-url.outputs.app-url }}
        run: |
          echo "ðŸš€ Deploy realizado com sucesso!"
          echo "ðŸ“± URL da aplicaÃ§Ã£o: $APP_URL"
