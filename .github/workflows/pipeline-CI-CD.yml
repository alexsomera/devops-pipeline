name: Pipeline CI/CD - Deploy para AWS S3

on:
  push:
    branches: [ "main" ]

# Variáveis de ambiente para o workflow
env:
  AWS_REGION: us-east-1

jobs:
  # Job 1: Testes e Build
  test-and-build:
    name: Testes e Build da Aplicação
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout do código
        uses: actions/checkout@v4
      
      - name: Instala o Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Instala dependências
        run: npm ci

      - name: Executa testes automatizados
        run: npm run test:ci

      - name: Build da aplicação
        run: npm run build

      - name: Upload dos artefatos de build
        uses: actions/upload-artifact@v4
        with:
          name: build-files
          path: build/
          retention-days: 1

  # Job 2: Deploy (só executa se o job anterior passar)
  deploy:
    name: Deploy para S3
    runs-on: ubuntu-latest
    needs: test-and-build
    
    steps:
      - name: Download dos artefatos de build
        uses: actions/download-artifact@v4
        with:
          name: build-files
          path: build/

      - name: Configurar credenciais da AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy para AWS S3
        run: |
          # Detectar o bucket do website automaticamente
          BUCKET_S3=$(aws s3api list-buckets --query "Buckets[?contains(Name, 'website')].Name" --output text)
          
          if [ -z "$BUCKET_S3" ]; then
            echo "Bucket do website não encontrado!"
            exit 1
          fi
          
          echo "Fazendo deploy para bucket: $BUCKET_S3"
          
          # Sync dos arquivos de build para o bucket
          aws s3 sync build/ s3://$BUCKET_S3 --delete --cache-control "max-age=86400"
          
          # Mostrar URL do website
          URL="http://$BUCKET_S3.s3-website-$AWS_REGION.amazonaws.com"
          echo "✅ Website disponível em: $URL"
          
          # Adicionar ao summary do GitHub
          echo "Deploy Concluído!" >> $GITHUB_STEP_SUMMARY
          echo "Website: [$URL]($URL)" >> $GITHUB_STEP_SUMMARY
